<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KuyDumSHOP - ครบทุกฟีเจอร์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;900&display=swap');
        body { font-family: 'Kanit', sans-serif; background: #0b101b; color: #e2e8f0; margin: 0; }
        .glass-nav { background: rgba(11, 16, 27, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .admin-bg { background: linear-gradient(145deg, #1e1b4b, #1e1b4b); border: 1px solid #4338ca; }
        .product-card { background: #161e2d; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; }
        .product-card:hover { border-color: #0ea5e9; transform: translateY(-5px); }
        input, select { background: #0b101b !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#0b101b]">
        <div class="w-16 h-16 border-4 border-sky-500/20 border-t-sky-500 rounded-full animate-spin"></div>
        <h2 class="mt-4 text-xl font-bold italic text-sky-500 animate-pulse uppercase">KUYDUMSHOP</h2>
    </div>

    <!-- Auth -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-[#161e2d] rounded-[2rem] p-10 border border-white/5 shadow-2xl">
            <h1 class="text-4xl font-black italic text-center mb-8 uppercase">KUYDUM<span class="text-sky-500">SHOP</span></h1>
            <div id="login-form" class="space-y-4">
                <input id="l-email" type="email" placeholder="อีเมล" class="w-full p-4 rounded-xl outline-none focus:border-sky-500">
                <input id="l-pass" type="password" placeholder="รหัสผ่าน" class="w-full p-4 rounded-xl outline-none focus:border-sky-500">
                <button id="btn-login" class="w-full bg-sky-500 py-4 rounded-xl font-bold hover:bg-sky-600 transition">เข้าสู่ระบบ</button>
                <button onclick="toggleAuth(false)" class="w-full text-slate-400 text-sm">ยังไม่มีบัญชี? สมัครสมาชิก</button>
            </div>
            <div id="reg-form" class="hidden space-y-4">
                <input id="r-user" type="text" placeholder="ชื่อเล่น" class="w-full p-4 rounded-xl outline-none focus:border-green-500">
                <input id="r-email" type="email" placeholder="อีเมล" class="w-full p-4 rounded-xl outline-none focus:border-green-500">
                <input id="r-pass" type="password" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)" class="w-full p-4 rounded-xl outline-none focus:border-green-500">
                <button id="btn-reg" class="w-full bg-green-500 py-4 rounded-xl font-bold hover:bg-green-600 transition">ยืนยันสมัครสมาชิก</button>
                <button onclick="toggleAuth(true)" class="w-full text-slate-400 text-sm">กลับไปล็อกอิน</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="hidden">
        <nav class="glass-nav sticky top-0 z-50 px-6 py-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-black italic uppercase">KUYDUM<span class="text-sky-500">SHOP</span></h1>
                    <div id="admin-badge" class="hidden bg-orange-500 text-white text-[10px] px-2 py-1 rounded-full font-bold">ADMIN</div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400 uppercase leading-none">ยินดีต้อนรับคุณ <span id="user-name-display">...</span></p>
                        <p class="text-sky-400 font-bold">฿<span id="bal-display">0</span></p>
                    </div>
                    <button id="btn-logout" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-power-off text-xl"></i></button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-6">
            
            <!-- Admin Panel -->
            <section id="admin-panel" class="hidden mb-12 space-y-6">
                <div class="admin-bg p-8 rounded-3xl">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 text-indigo-400">
                        <i class="fas fa-tools"></i> แผงควบคุมผู้ดูแลระบบ
                    </h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Add Product -->
                        <div class="space-y-4">
                            <h3 class="font-bold text-sm text-slate-300 uppercase">เพิ่มสินค้าใหม่</h3>
                            <input id="p-name" type="text" placeholder="ชื่อสินค้า" class="w-full p-3 rounded-xl outline-none">
                            <input id="p-price" type="number" placeholder="ราคา" class="w-full p-3 rounded-xl outline-none">
                            <input id="p-image" type="text" placeholder="URL รูปภาพ (ถ้ามี)" class="w-full p-3 rounded-xl outline-none">
                            <button id="btn-add-p" class="w-full bg-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-500 transition">เพิ่มสินค้า</button>
                        </div>
                        <!-- Manage User Money -->
                        <div class="space-y-4">
                            <h3 class="font-bold text-sm text-slate-300 uppercase">จัดการเงินสมาชิก (ใช้ UID หรือ Email)</h3>
                            <input id="u-target" type="text" placeholder="อีเมลผู้รับ" class="w-full p-3 rounded-xl outline-none">
                            <input id="u-amount" type="number" placeholder="จำนวนเงิน" class="w-full p-3 rounded-xl outline-none">
                            <div class="flex gap-2">
                                <button id="btn-add-m" class="flex-1 bg-green-600 py-3 rounded-xl font-bold hover:bg-green-500 transition">เพิ่มเงิน</button>
                                <button id="btn-set-m" class="flex-1 bg-red-600 py-3 rounded-xl font-bold hover:bg-red-500 transition">เซ็ตเงิน</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Product Display -->
            <div>
                <h2 class="text-3xl font-bold mb-8 italic uppercase tracking-tight">รายการสินค้าทั้งหมด</h2>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Products -->
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBC0pg-gWH0kYX2paCmO_LCIWKiUISDarU",
            authDomain: "mywed56.firebaseapp.com",
            projectId: "mywed56",
            storageBucket: "mywed56.firebasestorage.app",
            messagingSenderId: "94954792072",
            appId: "1:94954792072:web:cd3269324e2387fd00eb3d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userData = null;

        // --- Auth & Initial ---
        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loading').style.display = 'none';
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                listenUserData(user.uid);
                listenProducts();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        function listenUserData(uid) {
            onSnapshot(doc(db, "users", uid), (snap) => {
                if (snap.exists()) {
                    userData = snap.data();
                    document.getElementById('user-name-display').innerText = userData.username;
                    document.getElementById('bal-display').innerText = userData.balance.toLocaleString();
                    if (userData.role === 'admin') {
                        document.getElementById('admin-badge').classList.remove('hidden');
                        document.getElementById('admin-panel').classList.remove('hidden');
                    }
                }
            });
        }

        function listenProducts() {
            onSnapshot(collection(db, "products"), (snap) => {
                const list = document.getElementById('product-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    list.innerHTML += `
                        <div class="product-card p-6 rounded-3xl relative">
                            ${userData?.role === 'admin' ? `<button onclick="deleteProduct('${d.id}')" class="absolute top-2 right-2 text-red-500 text-xs bg-red-500/10 p-2 rounded-lg">ลบ</button>` : ''}
                            <div class="w-full aspect-square bg-black/40 rounded-2xl mb-4 flex items-center justify-center overflow-hidden">
                                ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : `<i class="fas fa-box text-4xl text-slate-700"></i>`}
                            </div>
                            <h3 class="font-bold text-lg mb-1 truncate">${p.name}</h3>
                            <p class="text-sky-400 font-black text-2xl mb-4">฿${p.price.toLocaleString()}</p>
                            <button onclick="buyProduct('${d.id}', ${p.price}, '${p.name}')" class="w-full bg-white/5 hover:bg-sky-500 py-2 rounded-xl font-bold transition">ซื้อทันที</button>
                        </div>
                    `;
                });
            });
        }

        // --- Admin Actions ---
        document.getElementById('btn-add-p').onclick = async () => {
            const name = document.getElementById('p-name').value;
            const price = parseInt(document.getElementById('p-price').value);
            const image = document.getElementById('p-image').value;
            if(!name || !price) return alert("กรุณาใส่ชื่อและราคา");
            await addDoc(collection(db, "products"), { name, price, image, createdAt: new Date() });
            alert("เพิ่มสินค้าสำเร็จ");
        };

        window.deleteProduct = async (id) => {
            if(confirm("ลบสินค้านี้ใช่ไหม?")) await deleteDoc(doc(db, "products", id));
        };

        document.getElementById('btn-add-m').onclick = async () => {
            const email = document.getElementById('u-target').value;
            const amount = parseInt(document.getElementById('u-amount').value);
            const q = query(collection(db, "users"), where("email", "==", email));
            const qs = await getDocs(q);
            if(qs.empty) return alert("ไม่พบผู้ใช้นี้");
            await updateDoc(doc(db, "users", qs.docs[0].id), { balance: increment(amount) });
            alert("เพิ่มเงินสำเร็จ");
        };

        // --- User Actions ---
        window.buyProduct = async (id, price, name) => {
            if(userData.balance < price) return alert("เงินไม่พอครับ!");
            if(confirm(`ยืนยันการซื้อ ${name} ราคา ฿${price}?`)) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-price) });
                alert("ซื้อสำเร็จ! กรุณาติดต่อแอดมินเพื่อรับของ");
            }
        };

        // --- Auth Functions ---
        document.getElementById('btn-login').onclick = async () => {
            const e = document.getElementById('l-email').value;
            const p = document.getElementById('l-pass').value;
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { alert("อีเมลหรือรหัสผ่านผิด"); }
        };

        document.getElementById('btn-reg').onclick = async () => {
            const u = document.getElementById('r-user').value;
            const e = document.getElementById('r-email').value;
            const p = document.getElementById('r-pass').value;
            try {
                const qs = await getDocs(collection(db, "users"));
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                await setDoc(doc(db, "users", cred.user.uid), {
                    username: u, email: e, balance: 0, role: qs.empty ? 'admin' : 'user'
                });
                alert("สมัครสำเร็จ");
            } catch(err) { alert(err.message); }
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);
        window.toggleAuth = (isLogin) => {
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('reg-form').classList.toggle('hidden', isLogin);
        };
    </script>
</body>
</html>

            const email = document.getElementById('r-email').value.trim();
            const pass = document.getElementById('r-pass').value;
            try {
                const q = query(collection(db, "users"), limit(1));
                const qs = await getDocs(q);
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", cred.user.uid), {
                    username: user, email: email, balance: 0, role: qs.empty ? 'admin' : 'user'
                });
                alert("สมัครสำเร็จ");
            } catch (e) { alert(e.message); }
        };

        document.getElementById('btn-login').onclick = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value); } 
            catch (e) { alert("ล็อกอินไม่สำเร็จ"); }
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);
        window.toggleAuth = (isLogin) => {
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('reg-form').classList.toggle('hidden', isLogin);
        };

        function renderProducts() {
            const pds = [{n:"Key A", p:50}, {n:"Key B", p:100}, {n:"Key C", p:500}];
            document.getElementById('product-list').innerHTML = pds.map(p => `
                <div class="product-card p-6 rounded-3xl text-center">
                    <h3 class="text-xl font-bold mb-4">${p.n}</h3>
                    <p class="text-2xl font-black mb-4 text-sky-400">฿${p.p}</p>
                    <button class="bg-sky-500 w-full py-2 rounded-xl font-bold">ซื้อเลย</button>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
